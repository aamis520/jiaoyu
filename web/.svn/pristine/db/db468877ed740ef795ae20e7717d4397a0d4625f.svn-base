<style scoped="scoped" lang="less">
	.formTitle {
		-webkit-box-sizing: border-box;
		box-sizing: border-box;
		width: 1300px;
		background: #fff;
		overflow: hidden;
	}
	
	.titleLeft {
		color: #999;
		padding-left: 30px;
		margin-top: 30px;
		display: inline-block;
		float: left;
	}
	
	.titleRight {
		position: absolute;
		top: 20px;
		right: 20px;
		color: #4ed79f;
		padding-right: 17px;
		img {
			width: 20px;
			cursor: pointer;
			position: relative;
			top: 5px;
			margin: 0 3px;
		}
	}
	
	.dayChange {
		width: 60%;
		margin: 0 auto;
		height: 45px;
		line-height: 45px;
		text-align: center;
		font-size: 16px;
		position: relative;
		margin-top: 35px;
		color: #999;
		span {
			margin: 20px;
			cursor: pointer;
			padding-bottom: 5px;
			cursor: pointer;
		}
	}
	
	.shouruReport {
		padding: 0 30px;
		overflow-x: hidden;
		overflow-y: scroll;
		height: 500px;
		.tableClass {
			width: 100%;
			text-align: left;
			color: #666;
			box-sizing: border-box;
			td {
				height: 70px;
			    width: 9.5%;
			    -webkit-box-sizing: border-box;
			    box-sizing: border-box;
			    padding-left: 1%;
			}
			th {
				height: 45px;
				background-color: #eff0f6;
				font-size: 14px;
				color: #666;
			}
			.tdColorBlack {
				color: #666;
				img {
					margin-left: 3px;
					position: relative;
					top: 2px;
					cursor: pointer;
				}
			}
			span {
				color: #ff6f7a;
			}
			.tdColorGreen {
				color: #31c27c;
			}
			.tdColorBlue {
				color: #409eff;
				font-weight: bold;
				width: 14.5%;
				span {
					font-weight: bold;
				}
			}
			.bgGray {
				background-color: #f5f7fb;
			}
		}
	}
	
	.tdColorGreen01 {
		color: #31c27c;
	}
	
	.tdColorGreen {
		color: #31c27c;
		border-bottom: 1px solid #31c27c;
	}
	
	.detailLayer {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0, 0, 0, 0.6);
		.tancengBigBox {
			width: 1300px;
			margin: 0 auto;
			background-color: #FFFFFF;
			border-radius: 5px;
			position: relative;
			height: 600px;
			margin-top: 130px;
			.detailLtitle {
				box-sizing: border-box;
				height: 50px;
				text-align: center;
				border-bottom: 1px solid #e8e8e8;
				background-color: #eff3f5;
				font-size: 18px;
				color: #333333;
				border-top-left-radius: 5px;
				border-top-right-radius: 5px;
				width: 100%;
				.titleBox{
					height: 50px;
					line-height: 50px;
					text-align: center;
				}
				.detaiClose {
					width: 40px;
					text-align: center;
					height: 40px;
					line-height: 40px;
					color: #343535;
					position: absolute;
					font-size: 18px;
					top: 5px;
					right: 5px;
					cursor: pointer;
					border-radius: 5px;
					/*background-color: rgba(0,0,0,0.1);*/
					transform: scale(1, .8);
				}
			}
			.tableHeader {
				display: flex;
				width: 100%;
				background-color: #FFFFFF;
				height: 44px;
				line-height: 44px;
				font-size: 14px;
				color: #666666;
				border-bottom: 1px solid #e6e6e6;
				div {
					width: 10%;
					height: 44px;
					line-height: 44px;
					box-sizing: border-box;
					padding-left: 1%;
				}
				.tHeader10 {
					width: 15%;
				}
			}
			.tableContent {
				height: 500px;
				overflow-x: hidden;
				overflow-y: scroll;
				.tableClass {
					width: 100%;
					box-sizing: border-box;
					.tdColorBlue {
						color: #409eff;
						font-weight: bold;
						width: 14.5%;
						span {
							font-weight: bold;
						}
					}
					span {
						color: #ff6f7a;
					}
				}
				.tableClass tr{
					width: 100%;
					box-sizing: border-box;
				}
				.tableClass tr td {
					height: 70px;
					width: 9.5%;
					box-sizing: border-box;
					padding-left: 1%;
					
				}
				.tdColorBlack {
					color: #666;
					img {
						margin-left: 3px;
						position: relative;
						top: 2px;
						cursor: pointer;
					}
				}
			}
			.tableFooter {
				display: flex;
				width: 100%;
				background-color: #FFFFFF;
				font-size: 14px;
				color: #666666;
				border-top: 1px solid #e6e6e6;
				padding: 0;
				div {
					width: 10%;
					min-height: 50px;
					box-sizing: border-box;
					padding: 20px 0;
					padding-left: 1%;
				}
				.tHeader10 {
					width: 15%;
				}
			}
		}
	}
	.tableHeader01{
		display: -webkit-box;
	    display: -ms-flexbox;
	    display: flex;
	    width: 100%;
	    background-color: #FFFFFF;
	    height: 44px;
	    line-height: 44px;
	    font-size: 14px;
	    color: #666666;
	    margin-top: 20px;
	    padding: 0 30px;
	    box-sizing: border-box;
	    div{
	    	width: 10%;
		    height: 44px;
		    line-height: 44px;
		    -webkit-box-sizing: border-box;
		    box-sizing: border-box;
		    padding-left: 1%;
		    background-color: #eff0f6;
	    }
	    .tHeader10{
		    width: 15%;
		}
	}
	::-webkit-scrollbar-track-piece {
		background-color: rgba(0, 0, 0, 0);
		-webkit-border-radius: 0
	}
	
	::-webkit-scrollbar {
		width: 6px;
		height: 8px
	}
	
	::-webkit-scrollbar-thumb {
		height: 50px;
		background-color: #DDDFE0;
		-webkit-border-radius: 4px
	}
	
	::-webkit-scrollbar-thumb:hover {
		height: 50px;
		background-color: rgba(0, 0, 0, 0.2);
		-webkit-border-radius: 4px
	}
	.tableFooter{
		display: flex;
		width: 100%;
		background-color: #FFFFFF;
		font-size: 14px;
		color: #999;
		box-sizing: border-box;
		padding: 0 30px;
		border-top: 1px solid #e6e6e6;
		div {
			width: 10%;
			min-height: 50px;
			box-sizing: border-box;
			padding: 20px 0;
			padding-left: 1%;
		}
		.tHeader10 {
			width: 15%;
		}
		.colorBlack{
			display: block;
			color: #333333;
			padding-top: 5px;
		}
		.tdColorBlue {
			color: #409eff;
			font-weight: bold;
			span{
				color: #ff6f7a;
				font-weight: bold;
			}
		}
		.tdColorGreen01{
		    color: #31c27c;
		}
	}
</style>
<template>
	<div id="incomeForm">
		<div class="formTitle">
			<span class="titleLeft" v-model="nowMouth">{{nowMouth}}月财务收入日报（点击数据查看详细）</span>
			<div class="dayChange">
				<span class="tdColorGreen">日报</span>
				<span>周报 </span>
				<span>月报</span>
				<span>年报</span>
			</div>
			<div class="titleRight">
				<span class="tRdate" v-model="nowMouth">{{nowMouth}}</span>
				<span class="tRleft" @click="getCST(-1)"><img src="../../assets/arrowLeft.png"/></span>
				<span class="tRright" @click="getCST(1)"><img src="../../assets/arrowRight.png"/></span>
				<span class="tRset" style="display: none;"><img src="../../assets/set.png"/></span>
				<span class="tRtex" style="display: none;"><img src="../../assets/illustrate.png"/></span>
				<span class="tRserch" style="display: none;"><img src="../../assets/search.png"/></span>
			</div>
			<div class="tableHeader01">
				<div class="tHeader01">时间</div>
				<div class="tHeader02">学费收入</div>
				<div class="tHeader03">教材收入</div>
				<div class="tHeader04">物品收入</div>
				<div class="tHeader05">其他收入</div>
				<div class="tHeader06">前期欠款回款</div>
				<div class="tHeader07">当日新增欠款</div>
				<div class="tHeader08">前期欠款调整</div>
				<div class="tHeader09">前期尾款剩余</div>
				<div class="tHeader10">当日收入/欠款总计</div>
			</div>
		</div>
	
		
		<div class="shouruReport">
			<table class="tableClass" border="0" cellspacing="0" cellpadding="0">
				<tr v-for="(val, key, index) in dayForm" :class="{'bgGray':index%2 != 0}">
					<td class="tdColorBlack">{{key}}<img src="../../assets/incomeReport/incomeReport.png" v-if="headSchoolBoolean" @click.stop.prevent="showDetail(key)" /></td>
					<td>￥{{val.tuition_amount}}<br><span>￥{{val.tuition_debt}}</span></td>
					<td>￥{{val.teaching_amount}}<br><span>￥{{val.teaching_debt}}</span></td>
					<td>￥{{val.goods_amount}}<br><span>￥{{val.goods_debt}}</span></td>
					<td>￥{{val.other_amount}}<br><span>￥{{val.other_debt}}</span></td>
					<td>￥{{val.arrears_amount}}</td>
					<td>￥{{val.new_debt}}</td>
					<td class="tdColorGreen01">￥{{val.early_debt}}</td>
					<td>￥{{val.retainage_debt}}</td>
					<td class="tdColorBlue">￥{{val.all_amount}}<br><span>￥{{val.all_debt}}</span></td>
				</tr>
			</table>
			<!--用于显示没有数据情况-->
			<div style="padding: 20px; font-size: 20px;" v-model="noData" v-text="noData" v-show="noData"></div>
		</div>
		<div class="tableFooter">
			<div class="tHeader01" style="color: #333333;">总计</div>
			<div class="tHeader02">学费收入<span class="colorBlack">￥{{dayFormTotal.tuition_amount}}</span></div>
			<div class="tHeader03">教材收入<span class="colorBlack">￥{{dayFormTotal.teaching_amount}}</span></div>
			<div class="tHeader04">物品收入<span class="colorBlack">￥{{dayFormTotal.goods_amount}}</span></div>
			<div class="tHeader05">其他收入<span class="colorBlack">￥{{dayFormTotal.other_amount}}</span></div>
			<div class="tHeader06">前期欠款回款<span class="colorBlack">￥{{dayFormTotal.arrears_amount}}</span></div>
			<div class="tHeader07">当日新增欠款<span class="colorBlack">￥{{dayFormTotal.new_debt}}</span></div>
			<div class="tHeader08">前期欠款调整<span class="colorBlack tdColorGreen01">￥{{dayFormTotal.early_debt}}</span></div>
			<div class="tHeader09">前期尾款剩余<span class="colorBlack">￥{{dayFormTotal.retainage_debt}}</span></div>
			<div class="tHeader10">欠款总计<span class="colorBlack tdColorBlue">￥{{dayFormTotal.all_amount}}<br><span>￥{{dayFormTotal.all_debt}}</span></span></div>
		</div>
		
		
		<div class="detailLayer" v-if="showDetial">
			<div class="tancengBigBox">
				<div class="detailLtitle">
					<div class="titleBox">{{schoolName}}{{detialTime}}月分校财务月报</div>
					<div class="detaiClose"  @click.stop.prevent="closeDetail()">
						X
					</div>
				</div>
				<div class="tableHeader">
					<div class="tHeader01">校区</div>
					<div class="tHeader02">学费收入</div>
					<div class="tHeader03">教材收入</div>
					<div class="tHeader04">物品收入</div>
					<div class="tHeader05">其他收入</div>
					<div class="tHeader06">前期欠款回款</div>
					<div class="tHeader07">当日新增欠款</div>
					<div class="tHeader08">前期欠款调整</div>
					<div class="tHeader09">前期尾款剩余</div>
					<div class="tHeader10">欠款总计</div>
				</div>
				<div class="tableContent">
					<table class="tableClass" border="0" cellspacing="0" cellpadding="0">
						<tr v-for="(val,key,index) in FormLayer">
		                    <td class="tdColorBlack">{{key}}</td>
		                    <td>{{val.tuition_amount}}<br><span>{{val.tuition_debt}}</span></td>
		                    <td>{{val.teaching_amount}}<br><span>{{val.teaching_debt}}</span></td>
		                    <td>{{val.goods_amount}}<br><span>{{val.goods_debt}}</span></td>
		                    <td>{{val.other_amount}}<br><span>{{val.other_debt}}</span></td>
		                    <td>{{val.arrears_amount}}</td>
		                    <td>{{val.new_debt}}</td>
		                    <td class="tdColorGreen01">{{val.early_debt}}</td>
		                    <td>{{val.retainage_debt}}</td>
		                    <td class="tdColorBlue">{{val.all_amount}}<br><span>{{val.all_debt}}</span></td>
		                </tr>
					</table>
				</div>
				<div class="tableFooter">
					<div class="tHeader01" style="color: #333333;">总计</div>
					<div class="tHeader02">学费收入<span class="colorBlack">￥{{FormLayerTotal.tuition_amount}}</span></div>
					<div class="tHeader03">教材收入<span class="colorBlack">￥{{FormLayerTotal.teaching_amount}}</span></div>
					<div class="tHeader04">物品收入<span class="colorBlack">￥{{FormLayerTotal.goods_amount}}</span></div>
					<div class="tHeader05">其他收入<span class="colorBlack">￥{{FormLayerTotal.other_amount}}</span></div>
					<div class="tHeader06">前期欠款回款<span class="colorBlack">￥{{FormLayerTotal.arrears_amount}}</span></div>
					<div class="tHeader07">当日新增欠款<span class="colorBlack">￥{{FormLayerTotal.new_debt}}</span></div>
					<div class="tHeader08">前期欠款调整<span class="colorBlack tdColorGreen01">￥{{FormLayerTotal.early_debt}}</span></div>
					<div class="tHeader09">前期尾款剩余<span class="colorBlack">￥{{FormLayerTotal.retainage_debt}}</span></div>
					<div class="tHeader10">欠款总计<span class="colorBlack tdColorBlue">￥{{FormLayerTotal.all_amount}}<br><span>￥{{FormLayerTotal.all_debt}}</span></span></div>
				</div>
			</div>
		</div>
	</div>
</template>

<script>
	/*分校ID:59e5b78443a7f90b94660b05
	    地区ID:59e5d38d43a7f90cf478c3dc
	    总校ID:59e5b1f743a7f90998e16dd7*/
	import cont from '../../common/const'

	export default {
		name: 'incomeForm',
		data() {
			return {
				tishiFont: '当前测试为总校(点击切换)',
				tishiTip: 1,
				headSchoolId: '59e5b1f743a7f90998e16dd7',
				schoolId: '59e5b78443a7f90b94660b05',
				sqlID: '',
				nowMouth: '',
				hideDate: '',
				dayForm: {
					'2017-11-31': {
						'tuition_amount': 0,
						'tuition_debt': 0,
						'teaching_amount': 0,
						'teaching_debt': 0,
						'goods_amount': 0,
						'goods_debt': 0,
						'other_amount': 0,
						'other_debt': 0,
						'arrears_amount': 0,
						'all_amount': 0,
						'new_debt': 0,
						'early_debt': 0,
						'retainage_debt': 2550,
						'all_debt': 2550
					}
				},
				dayFormTotal:{
					
				},
				FormLayer: {
					'2017-11-31': {
						'tuition_amount': 0,
						'tuition_debt': 0,
						'teaching_amount': 0,
						'teaching_debt': 0,
						'goods_amount': 0,
						'goods_debt': 0,
						'other_amount': 0,
						'other_debt': 0,
						'arrears_amount': 0,
						'all_amount': 0,
						'new_debt': 0,
						'early_debt': 0,
						'retainage_debt': 2550,
						'all_debt': 2550
					}
				},
				FormLayerTotal:{
					
				},
				noData: '',
				showDetial:false,//控制弹出隐藏
				detialTime:'',//时间头
				schoolName:'',//学校名字
				timeFormat:'',//格式化时间日期用于发送请求
				saveNowTime:'',//保存当前时间
				headSchoolBoolean:true,//当前是否是总校
			}
		},
		mounted() {
			this.headSchoolId = this.$ls.get('USER_INFO').headSchoolId
			this.schoolId = this.$ls.get('USER_INFO').schoolId
			this.schoolName = this.$ls.get('USER_INFO').schoolName
			this.headSchoolBoolean = this.$ls.get('USER_INFO').headSchoolBoolean
			let time = new Date();
			this.saveNowTime = time.getTime()
			this.hideDate = time.setDate(1)
			this.getCST(0)
			
		},
		methods: {
			getCST(num) {
				//获取当前表中日期 年月等信息
				let oldTime = new Date(this.hideDate)
				let oldYear = oldTime.getFullYear()
				let oldMouth = oldTime.getMonth() + num

				if(oldMouth < 0) {
					oldYear = oldYear - 1
					oldMouth = 11
				} else if(oldMouth > 11) {
					oldYear = oldYear + 1
					oldMouth = 0
				}

				let newTime = new Date(oldYear, oldMouth, 1)
				
				
				if (newTime.getTime()>this.saveNowTime) {
					console.log("时间大于当前月份，返回false");
					return false;
				}
				
				this.hideDate = newTime

				let timeTotal = newTime.toString().split(' ') //转成字符串
				let newCST = timeTotal[0] + ' ' + timeTotal[1] + ' ' + timeTotal[2] + ' 00:00:00 CST ' + timeTotal[3] ///拼接成CST日期格式

				let getNewMouth = newTime.getMonth() + 1 //获取新月份
				this.nowMouth = timeTotal[3] + '-' + getNewMouth ///2017-11

				//发送请求数据
				let url = cont.finance + 'v1/financestat/financialincome/selectIncomeStatements?accessToken=aaaa&headSchoolId=' + this.headSchoolId + '&queryMonth=' + newCST
				this.axios.post(url).then((res) => {
					if(!res.data.messages.data) {
						this.noData = '没有数据'
						this.dayForm = {}
						this.dayFormTotal = {}
					} else {
						let newDay = {}
						let newDayTotal = {}
						for(let i in res.data.messages.data) {
							if(i !== 'total') {
								newDay[i] = res.data.messages.data[i]
							} else {
								newDayTotal.total = res.data.messages.data[i]
							}
						}
						this.dayForm = newDay
						this.dayFormTotal = newDayTotal.total
						this.noData = ''
					}
				}).catch(function(error) {
					console.log(error)
				})
			},
			showDetail(time) {
				this.showDetial = true;
				this.detialTime = time;
				this.timeFormat = time.replace(/-/g,'/');
				let url = cont.finance + 'v1/financestat/financialincome/selectSchoolIncomeStatements?accessToken=aaaa&headSchoolId=' + this.headSchoolId + '&queryDay=' + this.timeFormat
				this.axios.post(url).then((res) => {
					if(!res.data.messages.data) {
						this.FormLayer = {}
						this.FormLayerTotal = {}
					} else {
						let newDay = {}
						let newDayTotal = {}
						for(let i in res.data.messages.data) {
							if(i !== 'total') {
								newDay[i] = res.data.messages.data[i]
							} else {
								newDayTotal.total = res.data.messages.data[i]
							}
						}
						this.FormLayer = newDay
						this.FormLayerTotal = newDayTotal.total
						console.log(this.FormLayer)
						console.log(this.FormLayerTotal)
					}
				}).catch(function(error) {
					console.log(error)
				})
			},
			closeDetail(){
				this.showDetial = false;
			}
		}
	}
</script>