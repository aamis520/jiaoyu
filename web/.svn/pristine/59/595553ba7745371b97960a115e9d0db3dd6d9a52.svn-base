<style lang="less" scoped>
    .common {
        width: 100%;
        height: 48px;
        background: #fff;
        border-radius: 6px;
        li {
            float: left;
            line-height: 48px;
            margin-left: 40px;
            cursor: pointer;
            font-size: 15px;
            position: relative;
        }
        .act {
            background: white;
            color: #59ce97;
        }
        .titleRight {
            float: right;
            line-height: 48px;
            margin-right: 40px;
            font-size: 15px;
            position: relative;
        }
    }

    .list_bootom {
        width: 688px;
        margin-top: 14px;
        border-radius: 6px;
        .bottom_img {
            width: 100%;
            position: relative;
            background: #fff;
            border-radius: 6px;
            box-sizing: border-box;
            padding: 0 26px;
            padding-top: 0;
            margin-top: 14px;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            h3 {
                height: 60px;
                line-height: 60px;
                font-size: 15px;
                border-bottom: 1px solid #ccc;
            }
            .topSearch {
                position: absolute;
                top: 15px;
                right: 130px;
                width: 200px;
                input {
                    background: #f2f5f8;
                }
            }
            button {
                background-color: #eaf9f2;
                border: 1px solid #59ce97;
                border-radius: 5px;
                color: #59ce97;
                padding: 8px 24px;
                display: block;
                position: absolute;
                top: 15px;
                right: 30px;
                outline: none;
                cursor: pointer;
            }
        }
    }

    .contentBigBox {
        .contentBlock {
            width: 100%;
            overflow: hidden;
            box-sizing: border-box;
            border-radius: 5px;
            min-height: 124px;
            padding: 25px 26px;
            background-color: #fff;
            margin-bottom: 15px;
            cursor: pointer;
            display: flex;
            .contentLeft {
                flex: 1;
                padding-right: 10px;
                .cTitle {
                    font-size: 16px;
                }
                .cOperation {
                    margin-top: 10px;
                    .del {
                        color: #59ce97;
                        margin-right: 20px;
                        cursor: pointer;
                    }
                    .time,
                    .partake {
                        margin-right: 10px;
                        color: #999;
                    }
                }
            }
            .contentRight {
                width: 80px;
                img {
                    display: block;
                    width: 80px;
                    height: 80px;
                }
            }
        }
        & > :first-child {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
    }

    .el-input__icon {
        position: relative;
    }

    .publishTopic {
        overflow: hidden;
        width: 688px;
        background: #fff;
        border-radius: 6px;
        box-sizing: border-box;
        padding: 20px 26px;
        .img_array {
            display: block;
            width: 152px;
            height: 90px;
            margin-right: 14px;
            float: left;
        }
        .ngl_img {
            margin-top: 15px;
            height: 100px;
    		overflow: hidden;
        }
        .ngl_title {
            .textTitle {
                padding: 25px 5px;
                font-size: 18px;
                color: #333;
                margin: 25px 0;
                height: 45px;
                line-height: 45px;
                box-sizing: border-box;
                border-top: 1px solid #eee;
                border-bottom: 1px solid #eee;
            }
        }
        .ngl_content {
            textarea {
                width: 98%;
                border: 1px solid #eee;
                border-radius: 4px;
                background: #fff;
                padding: 5px;
                font-size: 16px;
                color: #666;
                resize: none;
            }
        }
    }

    .footer_img_btn {
        width: 100%;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        section {
            width: 176px;
            height: 34px;
            text-align: center;
            line-height: 34px;
            cursor: pointer;
            margin: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            &:first-child {
                background: #e9f9f1;
            }
            &:last-child {
                background: #31c17b;
                color: #fff;
                border: none;
            }
        }
    }
    .detailPageBox {
        width: 100%;
        overflow: hidden;
        box-sizing: border-box;
        border-radius: 5px;
        min-height: 124px;
        padding: 25px 26px;
        background-color: #fff;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        .topClose {
            border-bottom: 1px solid #ddd;
            overflow: hidden;
            padding-bottom: 10px;
            i {
                float: right;
                padding: 0 20px;
                cursor: pointer;
            }
        }
        .topContent {
            .tTitle {
                width: 100%;
                text-align: center;
                box-sizing: border-box;
                padding: 10px;
                padding-top: 20px;
                font-size: 16px;
            }
            .tOperation {
                font-size: 16px;
                text-align: center;
                color: #999;
                span {
                    margin-right: 20px;
                }
                .del {
                    color: #59ce97;
                    cursor: pointer;
                    font-size: 14px;
                }
            }
            .imgBox {
                width: 390px;
                height: 310px;
                margin: 0 auto;
                margin-top: 25px;
                img {
                    display: block;
                    width: 100%;
                    height: 100%;
                }
            }
        }
        .contentBlock {
            width: 100%;
            overflow: hidden;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            border-radius: 5px;
            min-height: 124px;
            padding: 25px 26px;
            background-color: #fff;
            margin-bottom: 15px;
            cursor: pointer;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
        }
        .contentRight01 {
            width: 60px;
            img {
                display: block;
                width: 50px;
                height: 50px;
                border-radius: 50%;
            }
        }
        .contentLeft01 {
            flex: 1;
            padding-right: 10px;
            .cTitle {
                font-size: 14px;
                margin-bottom: 8px;
            }
            .del {
                color: #59ce97;
                margin-right: 20px;
                cursor: pointer;
            }
        }
        .time01 {
            color: #999;
            margin-left: 10px;
        }

    }
    .ngl_img_div{
    	img{
    		width: 150px;
    	}
    }
</style>
<style lang="less">
   #campusTopic_img{
   		 .el-upload--picture-card {
	        height: 90px;
	        line-height: 90px;
	    }
   		.el-upload--picture-card {
			width: 150px;
			height: 94px;
			line-height: 0px;
			display: flex;
			justify-content: center;
			align-items: center;
			flex-direction: column;
			font-size: 14px;
			color: #666;
			background: #F7F7FB;
			img {
				display: block;
				width: 20px;
				margin-bottom: 14px;
			}
		}
		.el-upload-list--picture-card .el-upload-list__item {
			width: 150px;
			height: 94px;
		}
		.el-upload-list--picture-card .el-upload-list__item {
			margin-right: 16px;
		}
   }
</style>
<template>
    <div class="campusTopic">
        <div class="common">
            <ul>
                <li class="act">校园话题</li>
            </ul>
        </div>
        <div class="list_bootom" v-if="showDate == 'listPage'">
            <div class="bottom_img">
                <h3>话题列表</h3>
                <div class="topSearch">
                    <div class="demo-input-suffix">
                        <el-input placeholder="请输入内容" @keyup.enter.native="searchBtn(searchText)" v-model="searchText">
                            <i slot="prefix" class="el-input__icon el-icon-search"></i>
                        </el-input>
                    </div>
                </div>
                <button @click.stop.prevent="changePublish()">
                    发话题
                </button>
            </div>
            <div class="contentBigBox">
                <div class="contentBlock" v-for="(ele,index) in getDate" :key="index" :id="ele.schoolTopicId" @click.stop.prevent="showDetail(ele.schoolTopicId)">
                    <div class="contentLeft">
                        <div class="cTitle">{{ele.title}}</div>
                        <div class="cOperation">
                            <span class="del" @click.stop.prevent="deleteSchoolTopic(ele.schoolTopicId)">删除</span><span class="partake">125人参与</span><span class="time">{{ele.createTime}}</span>
                        </div>
                    </div>
                    <div class="contentRight">
                        <img :src="ele.coverUrl" alt=""/>
                    </div>
                </div>
            </div>
        </div>
        <div class="list_bootom publishTopic" v-if="showDate =='publishPge'">
            <div class="title_img">
                <h3><span>上传话题封面</span></h3>
                <div class="ngl_img">
                	<!--图片上传列表-->
                	<el-dialog :visible.sync="dialogVisible" size="tiny">
                		<img width="100%" :src="dialogImageUrl" alt="" />
                	</el-dialog>
                	<el-upload id="campusTopic_img"
                		action="/api/api-aliyunoss/ossController/uploadImageOss?accessToken=aaaa&folder=header/"
                		list-type="picture-card"
                		:on-success="upSuccess"
                		:on-preview="handlePictureCardPreview"
                		:on-remove="handleRemove"
                		:file-list="imgArr" 
                		>
                		<img src="../../../static/home-icon/addimg.png"></img>
                        <span>添加图片</span>
                	</el-upload>
                </div>
                <p class="ngl_title">
                    <input type="text" class="textTitle" name="title" style="width:100%; box-sizing: border-box;" id="title" v-model="topicTitle" placeholder="输入话题标题"/>
                </p>
                <p class="ngl_content">
                    <textarea class="textContent" style="height:140px;" v-model="topicContent" placeholder="输入话题内容"></textarea>
                </p>
            </div>
            <div class="footer_img_btn">
                <section @click="cancelSchoolTopic()">取消</section>
                <section @click="saveSchoolTopic()">保存</section>
            </div>
        </div>
        <div class="list_bootom detailPage" v-if="showDate =='detailPage'">
            <div class="detailPageBox">
                <div class="topClose">
                    <i class="el-icon-close" @click.stop.prevent="closeDetail()"></i>
                </div>
                <div class="topContent" :id="getDetialDate.schoolTopicId">
                    <div class="tTitle">{{getDetialDate.title}}</div>
                    <div class="tOperation">
                        <span class="del">删除</span><span class="partake">125人参与</span><span class="time">2015-10-12</span>
                    </div>
                    <div class="imgBox">
                        <img :src="getDetialDate.coverUrl"/>
                    </div>
                </div>
            </div>
            <topic_comment :oneLevelComment="oneComment" v-if="oneComment"></topic_comment>
        </div>
    </div>
</template>
<script>
    import qs from 'qs'
    import cont from '../../common/const'
    import topicComment from './campusTopicComment'

    export default {
        name: 'campusTopic',
        data() {
            return {
                headSchoolId: '',//学校ID
                userIcon: '',//用户头像
                userName: '',//用户名
                searchText: '', //搜索内容
                showDate: 'listPage', //listPage列表数据，publishPge发表,detailPage详情
                dialogImageUrl: '',//element添加图片
                imgUrl:'',//图片地址
                dialogVisible: false,
                topicTitle: '',//话题标题
                topicContent: '',//话题内容
                getDate: [],//获取的数据列表页的数据
                getDetialDate: {},//获取详情页的数据
                imgArr:[],//页面图片回显
                oneComment:[],//存储详情下的一级评论
            }
        },
        mounted() {
            this.headSchoolId = this.$ls.get('USER_INFO').headSchoolId
            this.userName = this.$ls.get('USER_INFO').userName
            this.userIcon = this.$ls.get('USER_INFO').userIcon
            this.findSchoolTopicList()
        },
        components: {
        	'topic_comment':topicComment,
        },
        methods: {
            //搜索方法
            searchBtn(text) {
                console.log('你输入的文字是' + text + '，暂无搜索接口')
            },
            //图片上传
            /**
			 * 上传限制
			 * */
			 beforeAvatarUpload(file) {
		        const isJPG = file.type === 'image/jpeg';
		        const isLt2M = file.size / 1024 / 1024 < 2; 
		        if (!isJPG) {
		          this.$message.error('上传头像图片只能是 JPG 格式!');
		        }
		        if (!isLt2M) {
		          this.$message.error('上传头像图片大小不能超过 2MB!');
		        }
		        return isJPG && isLt2M;
		     },
            //删除图片执行的函数
            handleRemove(file, fileList) {
                //console.log(file, fileList)
                sessionStorage.removeItem("imgUrl")//清除sessionStorage
            },
            //点击放大镜执行的函数
            handlePictureCardPreview(file) {
                this.dialogImageUrl = file.url
                this.dialogVisible = true
            },
            //上传成功执行的函数
            upSuccess(response, file, fileList) {
                //console.log(response)
                //console.log(fileList)
                sessionStorage.imgUrl = file.response.messages.firsKey
                this.imgUrl = file.response.messages.firsKey
            },
            //校园话题列表
            findSchoolTopicList() {
                let url = cont.interconnection + 'v1/schoolTopic/findSchoolTopicList?accessToken=aaaa&headSchoolId=' + this.headSchoolId
                this.axios.post(url).then((getRes) => {
                	console.log(getRes)
                    if (getRes.data.messages.data) {
                        this.getDate = getRes.data.messages.data
                    } else {
                        this.getDate = []
                    }
                }).catch(function (error) {
                    console.log(error)
                })
            },
            //删除功能
            deleteSchoolTopic(id) {
                if (!id) {
                    return
                }
                let url = cont.interconnection + 'v1/schoolTopic/deleteSchoolTopic?accessToken=aaaa&schoolTopicId=' + id
                this.axios.post(url).then((delRes) => {
                    this.findSchoolTopicList()
                }).catch(function (error) {
                    console.log(error)
                })
            },
            //发表帖子
            changePublish() {
                this.showDate = 'publishPge'
                if (sessionStorage.imgUrl) {
                	this.imgArr = [];
                	let saveUrl = {};
	                saveUrl.url = sessionStorage.imgUrl;
	                this.imgArr.push(saveUrl);
                }
            },
            //取消操作
            cancelSchoolTopic() {
                this.topicTitle = ''
                this.topicContent = ''
                this.showDate = 'listPage'
                this.handleRemove()//清除sessionStorage
            },
            // 保存操作
            saveSchoolTopic() {
                if (!!this.topicTitle && !!this.topicContent && !!this.imgUrl) {
                    let sendDate = qs.stringify({
                        'title': this.topicTitle,
                        'content': this.topicContent,
                        'coverUrl': this.imgUrl,
                        'headSchoolId': this.headSchoolId
                    })
                    let url = cont.interconnection + 'v1/schoolTopic/saveSchoolTopic?accessToken=aaaa'
                    this.axios.post(url, sendDate).then((getRes) => {
                        this.findSchoolTopicList()
                        this.cancelSchoolTopic()
                    }).catch(function (error) {
                        console.log(error)
                    })
                } else {
                    return
                }
            },
            //查看新闻详情页
            showDetail(id) {
                if (!id) {
                    return
                }
                let url = cont.interconnection + 'v1/schoolTopic/getSchoolTopic?accessToken=aaaa&schoolTopicId=' + id
                this.axios.post(url).then((showRes) => {
                    if (showRes.data.messages.data) {
                        this.getDetialDate = showRes.data.messages.data
                        this.showDate = 'detailPage'
                        this.findSchoolTopicShareList(id);
                    } else {
                        this.getDetialDate = []
                    }
                }).catch(function (error) {
                    console.log(error)
                })
            },
            //获取一级评论
            findSchoolTopicShareList(id) {
                let url = cont.interconnection + 'v1/schoolTopic/findSchoolTopicShareList?accessToken=aaaa&schoolTopicId=' + id
                this.axios.post(url).then((showRes) => {
                	console.log(showRes.data.messages.data)
                	this.oneComment = showRes.data.messages.data;
                }).catch(function (error) {
                    console.log(error)
                })
            },
            //关闭帖子详情页
            closeDetail() {
                this.showDate = 'listPage'
            }
        }
    }
</script>